@page "/answer/{QuestionId:int}"
@layout GameLayout
@using Microsoft.AspNetCore.Components
@using IQGame.Application.Models.Session
@using IQGame.Client.Services
@using IQGame.Shared.Models
@using System.Timers
@inject SessionService SessionService
@inject GameStateService GameState
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="question-view-page">
    <GameHeader Title="@GameState.SessionName" OnSwitchTeam="SwitchTeam" />

    <div class="question-view-body">
        <div class="sidebar-panel">
            <div class="teams-scores">
                @if (Team1 != null && Team2 != null)
                {
                    <div class="team-score-card team-1 @(Team1.Name == GameState.CurrentTurn ? "active-team" : "")">
                        @foreach (var anim in team1Animations)
                        {
                            <div class="score-animation @anim" style="animation-delay: @(anim == "score-up" ? "0s" : "0.1s");">
                                @(anim == "score-up" ? "+50" : "-150")
                            </div>
                        }
                        <h3 class="team-name">@Team1.Name</h3>
                        <p class="team-score">@Team1.Score</p>
                        <div class="team-help">
                            @if (Team1.Name == GameState.CurrentTurn)
                            {
                                <div class="help-indicator @(Team1.HelpTools?.KhiyaratUsed == true ? "used" : "available")" title="خيارات">
                                    <img src="images/helptools/brain.png" alt="خيارات" class="help-icon" />
                                    <span class="help-label">خيارات</span>
                                </div>
                                <div class="help-indicator @(Team1.HelpTools?.TwoAnswersUsed == true ? "used" : "available")" title="إجابتين">
                                    <img src="images/helptools/peace.png" alt="إجابتين" class="help-icon" />
                                    <span class="help-label">إجابتين</span>
                                </div>
                                <div class="help-indicator has-tooltip @(Team1.HelpTools?.DoublePointsUsed == true ? (Team1.HelpTools?.DoublePointsActive == true ? "active" : "used") : "available")" title="دبل">
                                    <img src="images/helptools/target.png" alt="دبل" class="help-icon" />
                                    <span class="help-label">دبل</span>
                                    <span class="tooltip-text">يجب التفعيل في اللوحة فقط</span>
                                </div>
                            }
                            else
                            {
                                <div class="help-indicator @(Team1.HelpTools?.KhiyaratUsed == true ? "used" : "available")" title="خيارات">
                                    <img src="images/helptools/brain.png" alt="خيارات" class="help-icon" />
                                    <span class="help-label">خيارات</span>
                                </div>
                                <div class="help-indicator @(Team1.HelpTools?.TwoAnswersUsed == true ? "used" : "available")" title="إجابتين">
                                    <img src="images/helptools/peace.png" alt="إجابتين" class="help-icon" />
                                    <span class="help-label">إجابتين</span>
                                </div>
                                <div class="help-indicator has-tooltip @(Team1.HelpTools?.DoublePointsUsed == true ? (Team1.HelpTools?.DoublePointsActive == true ? "active" : "used") : "available")" title="دبل">
                                    <img src="images/helptools/target.png" alt="دبل" class="help-icon" />
                                    <span class="help-label">دبل</span>
                                    <span class="tooltip-text">يجب التفعيل في اللوحة فقط</span>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="team-score-card team-2 @(Team2.Name == GameState.CurrentTurn ? "active-team" : "")">
                        @foreach (var anim in team2Animations)
                        {
                            <div class="score-animation @anim" style="animation-delay: @(anim == "score-up" ? "0s" : "0.1s");">
                                @(anim == "score-up" ? "+50" : "-150")
                            </div>
                        }
                        <h3 class="team-name">@Team2.Name</h3>
                        <p class="team-score">@Team2.Score</p>
                        <div class="team-help">
                            @if (Team2.Name == GameState.CurrentTurn)
                            {
                                <div class="help-indicator @(Team2.HelpTools?.KhiyaratUsed == true ? "used" : "available")" title="إجابتين">
                                    <img src="images/helptools/brain.png" alt="خيارات" class="help-icon" />
                                    <span class="help-label">خيارات</span>
                                </div>
                                <div class="help-indicator @(Team2.HelpTools?.TwoAnswersUsed == true ? "used" : "available")" title="إجابتين">
                                    <img src="images/helptools/peace.png" alt="إجابتين" class="help-icon" />
                                    <span class="help-label">إجابتين</span>
                                </div>
                                <div class="help-indicator has-tooltip @(Team2.HelpTools?.DoublePointsUsed == true ? (Team2.HelpTools?.DoublePointsActive == true ? "active" : "used") : "available")" title="دبل">
                                    <img src="images/helptools/target.png" alt="دبل" class="help-icon" />
                                    <span class="help-label">دبل</span>
                                    <span class="tooltip-text">يجب التفعيل في اللوحة فقط</span>
                                </div>
                            }
                            else
                            {
                                <div class="help-indicator @(Team2.HelpTools?.KhiyaratUsed == true ? "used" : "available")" title="خيارات">
                                    <img src="images/helptools/brain.png" alt="خيارات" class="help-icon" />
                                    <span class="help-label">خيارات</span>
                                </div>
                                <div class="help-indicator @(Team2.HelpTools?.TwoAnswersUsed == true ? "used" : "available")" title="إجابتين">
                                    <img src="images/helptools/peace.png" alt="إجابتين" class="help-icon" />
                                    <span class="help-label">إجابتين</span>
                                </div>
                                <div class="help-indicator has-tooltip @(Team2.HelpTools?.DoublePointsUsed == true ? (Team2.HelpTools?.DoublePointsActive == true ? "active" : "used") : "available")" title="دبل">
                                    <img src="images/helptools/target.png" alt="دبل" class="help-icon" />
                                    <span class="help-label">دبل</span>
                                    <span class="tooltip-text">يجب التفعيل في اللوحة فقط</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="return-badge" @onclick="ReturnToBoard">
                <span>العودة للوحة</span>
                <i class="fas fa-arrow-left"></i>
            </div>
        </div>
        <div class="quiz-main-panel">
            <div class="quiz-content">
                <div class="quiz-header">
                    <span class="quiz-score">@Question.Points نقطة</span>
                </div>
                <div class="quiz-image-container">
                    @if (CorrectAnswer != null && !string.IsNullOrEmpty(CorrectAnswer.ImageUrl))
                    {
                        <img src="@CorrectAnswer.ImageUrl" alt="Correct Answer" class="quiz-image" @onclick="() => ShowImageModal(CorrectAnswer.ImageUrl)" style="cursor:pointer;" />
                    }
                </div>
                <div class="quiz-question">
                    @if (CorrectAnswer != null)
                    {
                        <p>@CorrectAnswer.Text</p>
                    }
                    else
                    {
                        <p>لا توجد إجابة صحيحة متاحة لهذا السؤال</p>
                    }
                </div>
                <div class="quiz-footer">
                    <button class="scoring-btn" @onclick="GoToScoring">التقييم</button>
                    <div style="flex:1"></div>
                    <button class="answer-btn" @onclick="ReturnToQuestion">@(fromMCQ ? "العودة للاختيارات" : "العودة للسؤال")</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
@if (showImageModal)
{
    <div class="image-modal-overlay" @onclick="CloseImageModal">
        <div class="image-modal-content" @onclick:stopPropagation="true">
            <button class="image-modal-close" @onclick="CloseImageModal">×</button>
            <img src="@modalImageUrl" alt="Full size image" />
        </div>
    </div>
}

@code {
    [Parameter] public int QuestionId { get; set; }
    [Parameter] public bool fromMCQ { get; set; } = false;

    private SessionQuestionViewModel Question = new();
    private Answer? CorrectAnswer;
    private TeamViewModel? Team1 { get; set; }
    private TeamViewModel? Team2 { get; set; }
    private bool showImageModal = false;
    private string? modalImageUrl;
    private List<string> team1Animations = new();
    private List<string> team2Animations = new();

    protected override void OnInitialized()
    {
        // Game flow initialization
    }

    protected override async Task OnInitializedAsync()
    {
        await GameState.InitializeAsync();
        if (GameState.SessionId == 0)
        {
            NavManager.NavigateTo("/session-setup");
            return;
        }

        var allCategoriesTask = SessionService.GetSessionQuestionsAsync(GameState.SessionId);
        var gameStatusTask = SessionService.GetGameStatusAsync(GameState.SessionId);
        var answersTask = SessionService.GetAnswersForQuestionAsync(QuestionId);
        await Task.WhenAll(allCategoriesTask, gameStatusTask, answersTask);

        var allCategories = await allCategoriesTask;
        Question = allCategories.SelectMany(c => c.Questions).FirstOrDefault(q => q.QuestionId == QuestionId) ?? new();
        
        var gameStatus = await gameStatusTask;
        if (gameStatus != null)
        {
            GameState.SessionName = gameStatus.SessionName;
            GameState.Team1 = gameStatus.Team1Name;
            GameState.Team2 = gameStatus.Team2Name;
            GameState.CurrentTurn = gameStatus.CurrentTurn;
            
            Team1 = new TeamViewModel { Name = gameStatus.Team1Name, Score = gameStatus.Team1Score, HelpTools = gameStatus.Team1Help };
            Team2 = new TeamViewModel { Name = gameStatus.Team2Name, Score = gameStatus.Team2Score, HelpTools = gameStatus.Team2Help };

            await GameState.SaveAsync();
        }

        var allAnswers = await answersTask;
        // Get only the correct answer
        CorrectAnswer = allAnswers.FirstOrDefault(a => a.IsCorrect);

        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (bool.TryParse(query["fromMCQ"], out var fromMcqFlag))
        {
            fromMCQ = fromMcqFlag;
        }
    }

    private async Task SwitchTeam()
    {
        if (Team1 is null || Team2 is null) return;
        
        var currentTeamName = GameState.CurrentTurn;
        var nextTeamName = currentTeamName == Team1.Name ? Team2.Name : Team1.Name;
        
        var success = await SessionService.ChangeTurnAsync(GameState.SessionId, nextTeamName);
        if (success)
        {
            GameState.CurrentTurn = nextTeamName;
            await GameState.SaveAsync();
        }
    }

    private void GoToScoring()
    {
        NavManager.NavigateTo($"/scoring/{QuestionId}");
    }

    private void ReturnToQuestion()
    {
        if (fromMCQ)
            NavManager.NavigateTo($"/question-mcq/{QuestionId}");
        else
            NavManager.NavigateTo($"/question/{QuestionId}");
    }

    private async Task UseKhiyaratHelp(string teamName)
    {
        try
        {
            var success = await SessionService.UseHelpAsync(GameState.SessionId, teamName, "خيارات", QuestionId);
            if (success)
            {
                // Add score decrease animation
                AddScoreAnimation(teamName, -150);
                
                // Update the team's help status
                var team = Team1?.Name == teamName ? Team1 : Team2;
                if (team != null)
                {
                    team.HelpTools ??= new TeamHelpStatus();
                    team.HelpTools.KhiyaratUsed = true;
                    // Navigate to MCQ view
                    NavManager.NavigateTo($"/question-mcq/{QuestionId}");
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error using help tool: {ex.Message}");
        }
    }

    private async Task UseTwoAnswersHelp(string teamName)
    {
        try
        {
            var success = await SessionService.UseHelpAsync(GameState.SessionId, teamName, "إجابتين", QuestionId);
            if (success)
            {
                // Update the team's help status
                var team = Team1?.Name == teamName ? Team1 : Team2;
                if (team != null)
                {
                    team.HelpTools ??= new TeamHelpStatus();
                    team.HelpTools.TwoAnswersUsed = true;
                    // Handle two answers help (you can implement this later)
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error using help tool: {ex.Message}");
        }
    }

    private async Task UseDoublePointsHelp(string teamName)
    {
        try
        {
            var success = await SessionService.UseHelpAsync(GameState.SessionId, teamName, "دبل", QuestionId);
            if (success)
            {
                // Update the team's help status
                var team = Team1?.Name == teamName ? Team1 : Team2;
                if (team != null)
                {
                    team.HelpTools ??= new TeamHelpStatus();
                    team.HelpTools.DoublePointsUsed = true;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error using help tool: {ex.Message}");
        }
    }

    private void ReturnToBoard()
    {
        NavManager.NavigateTo($"/gameboard/{GameState.SessionId}");
    }

    public void Dispose()
    {
        // Do not show the navigation when component is disposed
        // GameState.HideNavigation = false; // Remove this line
    }

    public class TeamViewModel
    {
        public string? Name { get; set; }
        public int Score { get; set; }
        public TeamHelpStatus? HelpTools { get; set; }
    }

    private void ShowImageModal(string? imageUrl)
    {
        Console.WriteLine($"ShowImageModal called with: {imageUrl}");
        Console.WriteLine($"showImageModal before: {showImageModal}");
        if (!string.IsNullOrEmpty(imageUrl))
        {
            showImageModal = true;
            modalImageUrl = imageUrl;
            Console.WriteLine($"showImageModal after: {showImageModal}");
            Console.WriteLine($"modalImageUrl: {modalImageUrl}");
            StateHasChanged();
        }
    }

    private void CloseImageModal()
    {
        showImageModal = false;
    }

    private void AddScoreAnimation(string team, int points)
    {
        if (string.IsNullOrEmpty(team)) return;

        var animation = points > 0 ? "score-up" : "score-down";

        if (team == Team1?.Name)
        {
            team1Animations.Add(animation);
        }
        else if (team == Team2?.Name)
        {
            team2Animations.Add(animation);
        }
        StateHasChanged();

        _ = Task.Run(async () => {
            await Task.Delay(600); // Animation duration
            if (team == Team1?.Name)
            {
                team1Animations.Remove(animation);
            }
            else if (team == Team2?.Name)
            {
                team2Animations.Remove(animation);
            }
            await InvokeAsync(StateHasChanged);
        });
    }
}
